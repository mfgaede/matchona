<script type="text/javascript">
 
 $("#filters").on('change', function () {
   console.log('go');
  if (myClass == "all"){
    $("button.reset").click();
  }
  else {
    var myClass = this.value;
    vizFilter(myClass);
    $("input#quicksearch").val("");
    // Clear all previous filters and styling
    $(".line").removeClass("featured");
    $(".words").removeClass("featured");
    $(".line").removeClass("grey");
    $(".line").removeClass("grey-small");
    $(".line").removeClass("featured-filter");
    $('.line').removeClass("anchored-highlight");
    // Apply new filter
    $(".line").addClass("grey-small");
    $('div.' + myClass).removeClass("grey-small");
    $('div.' + myClass).addClass("featured-filter");

    // Build dropdown with all matching lines
    var itemcontainer = document.getElementById("contents-container");
    var items = itemcontainer.getElementsByClassName("line");
    var filterResults = '<option>Select and scroll to a matching line</option>';
    var lineCount = 0;

    for (var i = 0; i < items.length; i++) {
      if (items[i].classList.contains(myClass)) {
        var itemcontents = items[i].getElementsByClassName("words")[0];
        if (itemcontents) {
          filterResults += '<option class="text-truncate" value="'+ i +'">Line ' + (i + 1) + ' -- ' + itemcontents.textContent.substring(0,125) + '...</option>';
          lineCount++;
        }
      }
    }

    $("#searchResults").html(filterResults);
    $("#numberof").html(lineCount + " lines match this subject");
    $('.linecount').removeClass('d-none');
    $('.filter-search').removeClass('d-none');
    $("#numberoffilters").html("");
    $('.filtercount').addClass('d-none');

    let url = new URL(window.location);
    let params = url.searchParams;
    params.set('filter', myClass);
    params.delete('q');
    params.delete('scene');
    var p = params.toString();
    window.history.replaceState({}, '', location.pathname + '?' + p);
  // Scroll to first filtered item with offset for sticky header
  var targetOffset = $('.featured-filter:visible:first').offset().top;
  var headerOffset = 200; // Adjust this value to account for sticky header and padding
  $('html, body').animate({
    scrollTop: targetOffset - headerOffset
}, 1000);
  }
  });

   $("button.reset").click(function() {
  $("div").removeClass("grey"); 
  $("div").removeClass("grey-small"); 
  $("div").removeClass("featured-filter");
$("span.text-danger").replaceWith(function() { return $(this).text(); });
  $('.filtercount').addClass('d-none');  

  $('.filtercount').addClass('d-none');  
  $('div').removeClass("anchored-highlight"); 
    $("div").removeClass("featured");
    $("p").removeClass("featured");
    $('.filter-search').addClass('d-none');
    $("input#quicksearch").val(""); 
    $("#filters").val($("#filters option:first").val());
    var numberofint = $('tr').length;
   $("#numberof").html(numberofint);
   let url = new URL(window.location);
let params = url.searchParams;
params.delete('q'); 
   params.delete('filter'); 
   var p = params.toString();
window.history.replaceState({}, '', location.pathname + '?' + p );
$("rect").removeClass("dark");
$("rect").removeClass (function (index, className) {
    return (className.match (/(^|\s)primary-\S+/g) || []).join(' ');
});         
 });


 function filterLines() {
    $('.line').removeClass("anchored-highlight");
    $(".line").removeClass("featured");
    $("div").removeClass("grey-small");
    $("div").removeClass("featured-filter"); // Clear subject filter when searching
    $(".line").addClass("grey");
    var input, filter, p, span, i;
    input = document.getElementById("quicksearch");
    let url = new URL(window.location);
    let params = url.searchParams;
    params.set('q', input.value);
    var p = params.toString();
    window.history.replaceState({}, '', location.pathname + '?' + p);
    filterplain = input.value;
    filter = input.value.toUpperCase();
    itemcontainer = document.getElementById("contents-container");
    item = itemcontainer.getElementsByClassName("line");
    var searchResults = '<option>Select and scroll to a matching line</option>';
    for (i = 0; i < item.length; i++) {
      itemcontents = item[i].getElementsByClassName("words")[0];
      var index = itemcontents.innerHTML.indexOf(filterplain);
      if (itemcontents) {
        if (itemcontents.innerHTML.toUpperCase().indexOf(filter) > -1) {
          itemcontents.classList.add("featured");
          itemcontents.classList.remove("grey");
          searchResults += '<option class="text-truncate" value="'+ i +'">Line ' + i + ' -- ' + itemcontents.innerHTML.substring(0,125) + '...</option>';
          itemcontents.innerHTML = itemcontents.innerHTML.replace(filterplain, "<span class='text-danger'>" + filterplain + "</span>");
          } else {
        }
      }
      // Reset subject filter dropdown to first option
      $("#filters").val($("#filters option:first").val());

     var numberofint = $('.featured').length;
     $("#numberof").html(numberofint + " lines match your query");
     $("#searchResults").html(searchResults);
     $('.linecount').removeClass('d-none');
     $('.filter-search').removeClass('d-none');
     $("#numberoffilters").html("");
    $('.filtercount').addClass('d-none');

    // Clear filter parameter from URL since we're now searching
    let searchUrl = new URL(window.location);
    let searchParams = searchUrl.searchParams;
    searchParams.delete('filter'); 
    }
  }


  function scrollToLine() {
  var line_array_num = document.getElementById('searchResults').value;
  const featured_lines = document.getElementsByClassName('line');
  var line_num = parseInt(line_array_num);
  var position = featured_lines[line_num].offsetTop;
  var plus_position = parseInt(position) - 300;
  // Get the height of the iframe-wrapper and the document
  var iframeWrapper = document.getElementById('object-meta');
  var iframeWrapperHeight = iframeWrapper.offsetHeight;
  // Get the height of the banner
  var banner = document.getElementById('banner');
  var bannerHeight = banner.offsetHeight;

  var documentHeight = document.body.scrollHeight + bannerHeight;
  //Scroll tot he position
  window.scroll({
    top: plus_position,
    behavior: 'smooth'
  });
console.log(position + ' - ' + plus_position);
}





  // click goButton to search if return pressed in search box
  $('#quicksearch').keypress(function(e){
       if(e.which == 13){//Enter key pressed
           $('#goButton').click();
           //Trigger search button click event
        }
   });


$(document).ready(function() {
 let url = new URL(window.location);
let params = url.searchParams;
var dataFilter = url.searchParams.get('q');
var codeFilter = url.searchParams.get('filter');
var hashfilter = decodeURIComponent(location.hash.substr(1));//.replace(/%20/g, " ");
 if(dataFilter) { 
     // code to be executed if a hash is contained in the url
  $('#quicksearch').val($('#quicksearch').val() + dataFilter);
 $('#goButton').click();
 params.delete('filter'); 
 $('#filter-button').click();

 //$(hashfilterclass).addClass('active');
 }
 else if(codeFilter) { params.delete('q'); 
     // code to be executed if a filter is contained in the url search parameters
  $('#filters').val(codeFilter).change();
  $('#filter-button').click();
 //$(hashfilterclass).addClass('active');
 }
 else if(hashfilter) { params.delete('q'); 
     // code to be executed if an anchor (#) is contained in the url
     $('#' + hashfilter).addClass('anchored-highlight');

 }
 else{
 }});
 


 function vizFilter(x) {
  $("rect").removeClass (function (index, className) {
    return (className.match (/(^|\s)primary-\S+/g) || []).join(' ');
});    
              $("rect").addClass("dark");            
              $('rect.' + x).toggleClass("dark").addClass("primary-" + x);
              $("rect").not('.dark').closest('div.vizdiv').removeClass("hidden");
          }
  

</script>